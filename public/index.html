<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Artist Events</title>
	<link href="https://fonts.googleapis.com/css?family=Muli:400,600,700,900" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/normalize.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>
	<div id="login">
		<h1>This is an example of the Authorization Code flow</h1>
		<a href="/login" class="btn btn-primary">Log in with Spotify</a>
	</div>
	<div id="loggedin">
		<header>
			<div class="content-wrapper">
				<div class="user-info" id="user-info"></div>
				<div class="actions">
					<a href="#" class="header-btn">Change Location</a>
					<a href="#" class="header-btn">Logout</a>
				</div>
			</div>
		</header>
		<div class="body-content">
		<div class="content-wrapper">
			<section id="artists">
				<div class="section-heading">
					<div class="section-heading__title">Your Artists</div>
					<a href="#" class="btn btn-flat">Manage on Spotify</a>
				</div>
				<div class="artist-list" id="user-artists">
					You don't follow any artists on Spotify yet!
				</div>
			</section>
			<section id="upcoming-events">
				<div class="section-heading">
					<div class="section-heading__title">Upcoming Events</div>
					<div class="section-heading__subtitle">Near Columbus, Ohio</div>
				</div>
				<ul class="events-list" id="user-events">
					
				</ul>
			</section>
			<section id="recommended-events">
				<div class="section-heading">
					<div class="section-heading__title">Recommended</div>
					<div class="section-heading__subtitle">Concerts that you might be interested in</div>
				</div>
				<ul class="events-list">
					<li class="event">
						<div class="event-date">
							<div class="event-date__month">May</div>
							<div class="event-date__day">20</div>
						</div>
						<div class="event-info">
							<div class="event-info__name">Portugal. The Man</div>
							<div class="event-info__location">Express Live!, 7:00pm</div>
						</div>
						<div class="event-buttons">
							<a href="#" class="btn btn-primary">Buy Tickets</a>
						</div>
					</li>
					<li class="event">
						<div class="event-date">
							<div class="event-date__month">Sep</div>
							<div class="event-date__day">09</div>
						</div>
						<div class="event-info">
							<div class="event-info__name">Fall Out Boy</div>
							<div class="event-info__location">Nationwide Arena, 7:00pm</div>
						</div>
						<div class="event-buttons">
							<a href="#" class="btn btn-primary">Buy Tickets</a>
						</div>
					</li>
				</ul>
			</section>
			<div id="oauth">
			</div>
			<button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
		</div>
		</div>
	</div>

	<script id="user-info-template" type="text/x-handlebars-template">
		<div class="user-info__picture" style="background-image:url('{{images.0.url}}');"></div>
		<div class="user-info__text">
			<div class="user-info__name">
				{{#if display_name}}
					{{display_name}}
				{{else}}
					{{id}}
				{{/if}}
			</div>
			<div class="user-info__location">Columbus, OH</div>
		</div>
	</script>

	<script id="user-artists-template" type="text/x-handlebars-template">
	  <a href="{{external_urls.spotify}}" target="_blank" class="artist">
		<div class="artist-image" style="background-image:url('{{images.1.url}}');"></div>
		<div class="artist-name">{{name}}</div>
	</script>

	<script id="events-template" type="text/x-handlebars-template">
		<li class="event">
			<div class="event-date">
				<div class="event-date__month">{{eventMonth}}</div>
				<div class="event-date__day">{{eventDay}}</div>
			</div>
			<div class="event-info">
				<div class="event-info__name">
					{{#if hasHeadliner}}
						<div class="event-info__headliner">{{displayName}}</div>
						<div class="event-info__supporting">{{supportingAct}}</div>
					{{else}}
						{{name}}
					{{/if}}
				</div>
				<div class="event-info__location">
					{{_embedded.venues.0.name}}, {{eventTime}}
				</div>
			</div>
			<div class="event-buttons">
				{{#if distanceWarning}}
					<a href="#" class="btn btn-flat btn-warning">!</a>
				{{/if}}
				<a href="{{url}}" target="_blank" class="btn btn-primary">Buy Tickets</a>
			</div>
		</li>
	</script>

	<script id="oauth-template" type="text/x-handlebars-template">
		<h2>oAuth info</h2>
		<dl class="dl-horizontal">
			<dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
			<dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
		</dl>
	</script>

	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script>
		var artists = [];
		var events = [];
		var recommendedArtists = [];
		var recommendedEvents = [];
		var geoPoint = 'dphgr';

		(function() {

			var userInfoSource = document.getElementById('user-info-template').innerHTML,
				userInfoTemplate = Handlebars.compile(userInfoSource),
				userInfoPlaceholder = document.getElementById('user-info');

			var userArtistsSource = document.getElementById('user-artists-template').innerHTML,
				userArtistsTemplate = Handlebars.compile(userArtistsSource),
				userArtistsPlaceholder = document.getElementById('user-artists');

			var eventsSource = document.getElementById('events-template').innerHTML,
				eventsTemplate = Handlebars.compile(eventsSource),
				userEventsPlaceholder = document.getElementById('user-events');

			var oauthSource = document.getElementById('oauth-template').innerHTML,
				oauthTemplate = Handlebars.compile(oauthSource),
				oauthPlaceholder = document.getElementById('oauth');

			var params = getHashParams();

			var access_token = params.access_token,
				refresh_token = params.refresh_token,
				error = params.error;

			/**
			 * Obtains parameters from the hash of the URL
			 * @return Object
			 */
			function getHashParams() {
				var hashParams = {};
				var e, r = /([^&;=]+)=?([^&;]*)/g,
					q = window.location.hash.substring(1);
				while ( e = r.exec(q)) {
					hashParams[e[1]] = decodeURIComponent(e[2]);
				}
				return hashParams;
			}

			function getRecommendedArtistsFromTopArtists(){
				$.ajax({
					url: 'https://api.spotify.com/v1/me/top/artists',
					headers:{
					  'Authorization': 'Bearer ' + access_token
					},
					success: function(response){
						var followedNames = artists.map(x => x.name);
						var topArtists = response.items;
						if(topArtists.length > 0){
							for(var i = 0; i < topArtists.length; i++){
								if(followedNames.indexOf(topArtists[i].name) == -1) recommendedArtists.push(topArtists[i]);
							}
						}
					}
				});
			}

			function getEventsForArtists(artistsList){
				$.ajax({
				  url: '/get/events',
				  data: {
					'artists': JSON.stringify(artistsList.map(x => x.name)),
					'geoPoint': geoPoint
				  }
				}).done(function(data) {
					var eventList = data.events;
					eventList.sort(function(a, b){
						var aDate = new Date(a.dates.start.dateTime);
						var bDate = new Date(b.dates.start.dateTime);
						if(aDate < bDate) return -1;
						else if(aDate > bDate) return 1;
						else return 0;
					});
					for(var i = 0; i < eventList.length; i++){
						var event = eventList[i];

						// server side, the time stuff gets messed up, so doing it here instead
						var eventDate = new Date(event.dates.start.dateTime).toDateString().split(" ");
						event.eventMonth = eventDate[1];
						event.eventDay = eventDate[2];
						event.eventTime = new Date(event.dates.start.dateTime).toLocaleTimeString().split(":00 ").join("").toLowerCase();
						userEventsPlaceholder.innerHTML += eventsTemplate(event);
					}
				});
			}

			if (error) {
			  alert('There was an error during the authentication');
			} else {
			  // if (access_token) {
				// render oauth info
				// oauthPlaceholder.innerHTML = oauthTemplate({
				//   access_token: access_token,
				//   refresh_token: refresh_token
				// });

				$.ajax({
					url: '/get/profile',
					success: function(response) {
					  userInfoPlaceholder.innerHTML = userInfoTemplate(response.user);

					  $('#login').hide();
					  $('#loggedin').show();
					}
				});

				$.ajax({
					url: '/get/artists',
					success: function(response){
						artists = response.artists;
						artists.sort(function(a, b){
							if(a.name < b.name) return -1;
							else if(a.name > b.name) return 1;
							else return 0;
						});
						if(artists.length > 0){
							userArtistsPlaceholder.innerHTML = "";
							for(var i = 0; i < artists.length; i++){
								userArtistsPlaceholder.innerHTML += userArtistsTemplate(artists[i]);
							}
						}

						getEventsForArtists(artists);
						// getRecommendedArtistsFromTopArtists();
					}
				});

			  // } else {
				 //  // render initial screen
				 //  $('#login').show();
				 //  $('#loggedin').hide();
			  // }

			  document.getElementById('obtain-new-token').addEventListener('click', function() {
				$.ajax({
				  url: '/refresh_token',
				  data: {
					'refresh_token': refresh_token
				  }
				}).done(function(data) {
				  access_token = data.access_token;
				  oauthPlaceholder.innerHTML = oauthTemplate({
					access_token: access_token,
					refresh_token: refresh_token
				  });
				});
			  }, false);
			}
		  })();
	</script>

</body>
</html>